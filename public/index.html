<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <link rel="icon" href="<%= BASE_URL %>LogoCQ.png">
    <title>Property-Map</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Material+Icons">
    <link
            href="https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.css"
            rel="stylesheet"
    />
    <!-- Vue-mapbox CSS -->
    <link
            href="https://cdn.jsdelivr.net/npm/vue-mapbox@latest/dist/vue-mapbox.css"
            rel="stylesheet"
    />
    <!-- Mapbox GL JS -->
    <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.js"></script>


    <script
            type="text/javascript"
            src="https://cdn.jsdelivr.net/npm/vue-mapbox@latest/dist/vue-mapbox.min.js"
    ></script>

    <script
            src="https://code.jquery.com/jquery-3.5.1.min.js"
            integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
            crossorigin="anonymous"></script>
  </head>
  <body>
    <noscript>
      <strong>We're sorry but Property-Map doesn't work properly without JavaScript enabled. Please enable it to continue.</strong>
    </noscript>
    <div id="app"></div>
    <script>

      function applyFiltersOnColumns(geos, conditionsObject) {

        var rawResults = geos.features.map(function (feature, index) {

          var columnNames=Object.keys(conditionsObject);
          var conditions=Object.values(conditionsObject);

          var fullConditionPhrase="";
          for(var i in columnNames){
            var columnName=columnNames[i];
            var columnValue=feature.properties.project[columnName];
            var condition=conditions[i];
            if(condition.startsWith("__DATE__")){
              condition=condition.replace("__DATE__","");
              columnValue=getPreparedtDate(columnValue);
              condition=getPreparedtDateCondition(condition);
              fullConditionPhrase += (i == 0 ? "" : " && ") + "(" + columnValue + condition + ")";
            }else {
              fullConditionPhrase += (i == 0 ? "" : " && ") + "('" + columnValue + "'" + condition + ")";
            }
          }

          var conditionsApply=eval(fullConditionPhrase);
          if(conditionsApply){
            return feature.properties.project;
            //return feature.properties.id;
          }else{
            return null;
          }
        });

        var filteredResults = rawResults.filter(function (result) {
          return result!=null;
        });

        return filteredResults;
      }

      function getPreparedtDate(dateStr){
        dateStr=dateStr.replace("\\","");
        var regexp = /^(0?[1-9]|[12][0-9]|3[01])[\/\-](0?[1-9]|1[012])[\/\-](\d{2})/g;
        var match=regexp.exec(dateStr);
        if(match==null){
          return null;
        }
        var prepared=match[3]+match[2]+match[1];
        return prepared;
      }

      function getPreparedtDateCondition(dateconditionStr){
        dateconditionStr=dateconditionStr.replace("\\","");
        var regexp = /^([<>|=]=?)(0?[1-9]|[12][0-9]|3[01])[\/\-](0?[1-9]|1[012])[\/\-](\d{2})/g;
        var match=regexp.exec(dateconditionStr);
        if(match==null){
          return null;
        }
        var prepared=match[1]+match[4]+match[3]+match[2];
        return prepared
      }

     /* $.getJSON("testBlob.json", function(geos) {
        //var filteredRecs= applyFiltersOnColumns(geos, {"Suburb": "=='SYDNEY'", "Stage": "=='Other'", "Ownership": "=='LOCAL GOVT'"});
        //var filteredRecs= applyFiltersOnColumns(geos, {"Suburb": "=='SYDNEY'", "Stage": "=='Other'", "Ownership": "=='LOCAL GOVT'", "Last Updated": "__DATE__==29\/03\/17"});
        var filteredRecs= applyFiltersOnColumns(geos, {"Suburb": "=='SYDNEY'",  "Last Updated": "__DATE__<29\/03\/17"});
        console.log(filteredRecs);
      });*/

    </script>
    <!-- built files will be auto injected -->
  </body>
</html>
